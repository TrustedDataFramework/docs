##   8.1 简介
&#160;&#160;&#160;&#160;&#160;&#160;共识引擎是区块链的引擎，维系着区块链世界的正常运转。共识算法就是为了达到共同认识所涉及的算法，它主要解决多点统一意见的问题。 常见的共识算法 有PoW(工作量证明)，PoS(股权证明)，VRF(可验证随机函数)等。

&#160;&#160;&#160;&#160;&#160;&#160;区块链的共识机制，其实就是自治生态系统内部生产关系的演变，其演变方式和人类历史进程有诸多相似。

&#160;&#160;&#160;&#160;&#160;&#160;原始社会，人类是以部落形式构成的，没有阶级，没有剥削，没有压迫，劳动成果的分配是多劳多得，对应的是比特币的POW共识机制——工作量证明机制。

&#160;&#160;&#160;&#160;&#160;&#160;捕猎能力越强的人，能有更高的生存几率，在部落里也会拥有更多的决定权。这里对应的机制为PoW，工作量证明机制，就是工作越多，收益越大，越有决定权。

&#160;&#160;&#160;&#160;&#160;&#160;随着部落人越来越多，生产力水平的逐步提高，出现产品的剩余之后，就出现了贫富分化，原先的共识机制也被破坏，而被阶级社会所取代，而形成了最初的国家。

&#160;&#160;&#160;&#160;&#160;&#160;这时对应的共识机制就是POS，权益证明机制，拥有的资产越多，决定权就越高，国家的利益与权利集中于皇权贵族。

&#160;&#160;&#160;&#160;&#160;&#160;但POS会带来马太效应，强者越强，弱者越弱，开始有一批人觉醒产生了新的思想，并且开始反抗，革命，对应现在的资本主义国家与社会主义国家。

&#160;&#160;&#160;&#160;&#160;&#160;对应的共识机制也演变成了DPoS，委托权益证明。由人民群众投票推选出代表，代表民众实行决定权，就像西方国家议会制度，中国的人民代表大会制度。

&#160;&#160;&#160;&#160;&#160;&#160;PoW和PoS是目前公有链最常用的共识机制，但是PoW和PoS在系统的处理能力上不足。主要体现在两个方面：一是区块速度不够快，例如比特币平均10分钟出一个区块，以太坊平均15s出一个区块；二是，每个区块的交易容量有限，例如比特币的区块大小在1M左右，大概能够包括2000笔交易。
## 8.2 共识类型
&#160;&#160;&#160;&#160;&#160;&#160;TDS支持POA、POS和POW。（后续会持续更新）
## 8.3 POA
### 8.3.1 POA 参数    

```yml
sunflower:
  consensus:
    name: 'poa' # 选择 poa 作为共识机制
    genesis: 'genesis/poa.jsonc' # 创世区块的 url，搜索优先级是 网路 > 文件系统 > classpath 
    block-interval: '1' # 出块间隔，最小值是一秒
    enable-mining: 'true' # 是否开启挖矿
    private-key: 'f00df601a78147ffe0b84de1dffbebed2a6ea965becd5d0bd7faf54f1f29c6b5' # 节点的私钥明文，建议使用环境变量的方式加载
    allow-empty-block: 'false' # 是否允许空块
    max-body-size: '2048' # 区块的最大事务数量限制
```

### 8.3.2 PoA的创世区块文件

```jsonc
{
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000", // 父区块的哈希值

  "timestamp": 1572511433, // 区块时间戳

  // 被允许出块的账户地址
  "miners": [{
      "addr": "9cbf30db111483e4b84e77ca0e39378fd7605e1b"
    },
    {
      "addr": "9cbf30db111483e4b84e77ca0e39378fd7605e1b"
    }

  ],

  // 预分配的账户余额
  "alloc":{
        "9cbf30db111483e4b84e77ca0e39378fd7605e1b": 1000000,
        "bf0aba026e5a0e1a69094c8a0d19d905367d64cf": 1000000
  }
}
```
### 8.3.3 POA的加入和退出

&#160;&#160;&#160;&#160;&#160;&#160;权威证明共识（又称PoA共识）规定，节点只有被授权以后才能参与区块链共识，也只有被授权的节点能加入 p2p 网络

&#160;&#160;&#160;&#160;&#160;&#160;poa 共识对应的创世区块中，miners 包含了所有被授权节点的公钥，只有拥有对应私钥的节点才可以加入 p2p 网络并参与共识

&#160;&#160;&#160;&#160;&#160;&#160;在 PoA 共识中有两个特殊的内置合约地址， 一个是 0000000000000000000000000000000000000003 和 0000000000000000000000000000000000000004。这两个内置合约分别保存了 p2p 许可的节点和被授权参与共识的节点。其他节点如果想加入 p2p 网络，需要构造请求事务发到相应的内置合约上面。

&#160;&#160;&#160;&#160;&#160;&#160;以加入 p2p 网络为例，流程如下：

&#160;&#160;&#160;&#160;&#160;&#160;1、节点 B 试图加入 p2p 网络，于是构造了如下事务发到了已经受到许可的节点A上
```json
{
    "version": 1634693120,
    "type": 3,
    "createdAt": "2020-07-29T07:16:40Z",
    "nonce": 1,
    "from": "节点B的公钥",
    "gasPrice": 0,
    "amount": 0,
    "payload": "00", 
    "to": "0000000000000000000000000000000000000003",
    "signature": "****",
    "hash": "**"
}
```  
&#160;&#160;&#160;&#160;&#160;&#160;2、节点A通过查看合约状态，收到了节点B的请求，并且同意了节点B的加入，构造了以下事务发到链上
```json
{
    "version": 1634693120,
    "type": 3,
    "createdAt": "2020-07-29T07:16:40Z",
    "nonce": 1,
    "from": "节点A的公钥",
    "gasPrice": 0,
    "amount": 0,
    "payload": "01拼接上节点A的地址" , 
    "to": "0000000000000000000000000000000000000003",
    "signature": "****",
    "hash": "**"
}
```
&#160;&#160;&#160;&#160;&#160;&#160;3、节点A通过了节点B的请求后，因为原先只有节点A处在授权节点中，所以满足了超过2/3同意的条件，节点B加入了 p2p 许可节点。若节点C再要加入 p2p 网络，则必须节点A和节点B都同意才可以，因为此时若只有节点A同意，没有满足 2/3 以上的同意。

## 8.4 POS

### 8.4.1 POS参数 (PoS)

```yml
sunflower:
  consensus:
    name: 'pos' # 选择 pos 作为共识机制
    genesis: 'genesis/pos.jsonc' # 创世区块的 url，搜索优先级是 网路 > 文件系统 > classpath 
    block-interval: '5' # 出块间隔，最小值是一秒
    enable-mining: 'true' # 是否开启挖矿
    allow-empty-block: 'true' # 是否出空块
    max-body-size: '2048' # 区块的最大事务数量限制
    max-miners: '10' #最大矿工数量
    miner-coin-base: '9cbf30db111483e4b84e77ca0e39378fd7605e1b' # 矿工收益地址
```


### 8.4.2 PoS的创世区块文件

```jsonc
{
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000", // 父区块的哈希值

  "timestamp": 1572511433, // 区块时间戳
  "miners": [{
      // 矿工 = 地址 + 投票数量
      "addr": "9cbf30db111483e4b84e77ca0e39378fd7605e1b",
      "vote": 100000000
    }
  ],

// 预分配的账户余额
  "alloc":{
        "9cbf30db111483e4b84e77ca0e39378fd7605e1b": 1000000,
        "bf0aba026e5a0e1a69094c8a0d19d905367d64cf": 1000000
  }
}
```
### 8.4.3 POS的加入和退出
&#160;&#160;&#160;&#160;&#160;&#160;PoS 即 Proof of Stake。在 PoS 共识中，股权较大的节点拥有区块打包权。这里的PoS使用内置合约保存每个账号收到的投票数量，地址是0000000000000000000000000000000000000005。

&#160;&#160;&#160;&#160;&#160;&#160;在这个内置合约中每个账号被按照投票数量排序，假设sunflower.consensus.max-miners=10，则投票排名前10的账户会获得区块打包权。

&#160;&#160;&#160;&#160;&#160;&#160;与 PoS 相关的事务有投票事务和取消投票的事务

1、投票事务

假设节点A给节点B投 1000 票，则节点A需要构造如下事务
```json
{
    "version": 7368563,
    "type": 3,
    "createdAt": "2020-07-29T07:16:40Z",
    "nonce": 1,
    "from": "节点A的公钥",
    "gasPrice": 0,
    "amount": 1000,
    "payload": "00拼接上节点B的地址" , 
    "to": "0000000000000000000000000000000000000005",
    "signature": "****",
    "hash": "**"
}
```

2、撤回投票事务

假设节点A要撤回给节点B的投票，需要构造如下事务
```json
{
    "version": 7368563,
    "type": 3,
    "createdAt": "2020-07-29T07:16:40Z",
    "nonce": 1,
    "from": "节点A的公钥",
    "gasPrice": 0,
    "amount": 0,
    "payload": "01拼接上投票事务的哈希值" ,
    "to": "0000000000000000000000000000000000000005",
    "signature": "****",
    "hash": "**"
}
```
3、节点A只有撤回给B的投票后才能重新投票
## 8.5 POW
### 8.5.1 POW 参数
```yml
sunflower:
  consensus:
    name: 'pow' # 选择 pow 作为共识机制
    genesis: 'genesis/pow.jsonc' # 创世区块的 url，搜索优先级是 网路 > 文件系统 > classpath 
    block-interval: '30' # 出块间隔，最小值是一秒，
    enable-mining: 'true' # 是否开启挖矿
    blocks-per-era: '100' # 每隔多少个区块调整一次难度值
    allow-empty-block: 'true' # 是否出空块
    max-body-size: '2048' # 区块的最大事务数量限制
    miner-coin-base: '9cbf30db111483e4b84e77ca0e39378fd7605e1b' # 矿工收益地址
```
### 8.5.2 PoW的创世区块文件

```json
{
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000", // 父区块的哈希值


  "timestamp": 1572511433, // 区块时间戳

  "nbits": "0000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff", // 初始难度值

  // 预分配的账户余额
  "alloc":{
        "9cbf30db111483e4b84e77ca0e39378fd7605e1b": 1000000,
        "bf0aba026e5a0e1a69094c8a0d19d905367d64cf": 1000000
  }
}
```
### 8.5.3 POW机制
&#160;&#160;&#160;&#160;&#160;&#160;PoW 即工作量证明，优先解决哈希值难题的矿工可获得区块打包权，工作量证明用伪代码表示如下：
```
while True:
  r = randbytes(32) # 生成随机 payload
  block['payload'] = r
  digest = hash(block)
  if digest < nbits: 
    # 完成了工作量证明
    break
```
&#160;&#160;&#160;&#160;&#160;&#160;这里的 PoW 使用内置合约保存难度值，该内置合约的地址为 0000000000000000000000000000000000000002，难度值会随时调整，不像比特币一样把难度值保存在区块头中。

&#160;&#160;&#160;&#160;&#160;&#160;PoW没有对 p2p 作出限制，也没有限制矿工的数量，只要能优先解决哈希值难题的矿工就可以获得区块打包权。